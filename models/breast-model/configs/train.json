{
    "import": ["$import glob", "$import os",
		"$import ignite",
		"$from model_def import ModelDefinition",
		"$from monai.losses import DiceCELoss",
		"$from torch.nn import CrossEntropyLoss",
		"$from scripts.createList import CreateImageLabelList"],
	"bundle_root": "/workspace/breast_classification",
	"ckpt_dir": "$@bundle_root + '/models'", 
	"output_dir": "$@bundle_root + '/eval'",
	"dataset_dir": "/workspace/data",
	"device": "$torch.device('cuda:0' if torch.cuda.is_available() else 'cpu')", 
	"network_def": {
		"_target_": "DenseNet121",
		"spatial_dims": 2,
		"in_channels": 3,
		"out_channels": 4
	},
	"network": "$@network_def.to(@device)",
	"data": {
		"_target_": "scripts.createList.CreateImageLabelList",
		"filename": "/raid/Data/MayoClinicData/BreastDensity/patient_img_label_FFDM.json"
	},
	"imagelist": "$@data.create_dataset()[0]",
	"labellist": "$@data.create_dataset()[1]",

	"loss": {
		"_target_": "torch.nn.CrossEntropyLoss"
		},
	"optimizer": {
		"_target_": "torch.optim.Adam",
		"params": "$@network.parameters()",
		"lr": 0.0001
		},
	"train": {
		"preprocessing": {
			"_target_": "Compose",
			"transforms": [
				{
					"_target_": "LoadImaged",
					"keys": [
						"image"
					]
				},
				{
					"_target_": "EnsureChannelFirstd",
					"keys": [
						"image"
					]
				},
				{
					"_target_": "ScaleIntensityd",
					"keys": "image",
					"minv": 0.0,
					"maxv": 1.0
				},
				{
					"_target_": "Resized",
					"keys": "image",
					"spatial_size": [
						299,
						299
					]
				}
			]
		},
		"dataset": {
		"_target_": "CacheDataset",
		"data": "$[{'image': i, 'label': l} for i, l in zip(@imagelist, @labellist)]",
		"transform": "@train#preprocessing",
		"cache_rate": 1.0,
		"num_workers": 4
	},
		"dataloader": {
		"_target_": "DataLoader",
		"dataset": "@train#dataset",
		"batch_size": 2,
		"shuffle": true,
		"num_workers": 4
	},
		"postprocessing":[{
			"_target_": "Activations",
			"softmax": true
		},
			{
				"_target_": "AsDiscrete",
				"argmax": true,
				"to_onehot":4
			}
			],
		"handlers":  [
			{
				"_target_":	"ValidationHandler",
				"validator"	: "@validate#evaluator",
				"epoch_level": true,
				"interval": 5
			},
			{
				"_target_": "StatsHandler",
				"tag_name": "train_loss",
				"output_transform": "$monai.handlers.from_engine(['loss'], first=True)"
			},
			{
				"_target_":"TensorBoardHandler",
				"log_dir": "@output_dir",
				"tag_name": "train_loss",
				"output_transforms": "$monai.handlers.from_engine(['loss'], first=True)"
			}
		]
	},
	"key_metric": {
		"train_accuracy": {
			"_target_": "ignite.metrics.Accuracy",
			"output_transform": "$monai.handlers.from_engine(['pred', 'label'])"
		}
	},
	"trainer": {
		"_target_": "SupervisedTrainer",
		"max_epochs": 2,
		"device": "@device",
		"train_data_loader": "@train#dataloader",
		"network": "@network",
		"loss_function": "@loss",
		"optimizer": "@optimizer",
		"postprocessing": "@train#postprocessing",
		"key_train_metric": "@train#key_metric",
		"train_handlers": "@train#handlers",
		"amp": true
	},
	"validate": {
		"preprocessing": {
			"_target_": "Compose",
			"transforms": "train#preprocessing"
		},
		"dataset": {
			"_target_": "CacheDataset",
			"data":  "$[{'image': i, 'label': l} for i, l in zip(@images, @labels)]",
			"transform": "@validate#preprocessing",
			"cache_rate": 1.0
		},
		"dataloader": {
			"_target_": "DataLoader",
			"dataset": "@validate#dataset",
			"batch_size": 1,
			"shuffle": false,
			"num_workers": 4
		},
		"training": [
			"$monai.utils.set_determinism(seed=123)",
			"$setattr(torch.backends.cudnn, 'benchmark', True)",
			"$@train#trainer.run()"
		]
	},
	"training": [
		"$monai.utils.set_determinism(seed=123)",
		"setattr(torch.backends.cudnn, 'benchmark', True)",
		"@trainer.run()"
	]
}
